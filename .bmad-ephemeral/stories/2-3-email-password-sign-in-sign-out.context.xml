<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>Email/Password Sign-In & Sign-Out</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/2-3-email-password-sign-in-sign-out.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user with a claimed account</asA>
    <iWant>sign in with my email and password from any device</iWant>
    <soThat>I can access my financial data wherever I am</soThat>
    <tasks>
      <task id="1" acs="2.3.1, 2.3.2, 2.3.3">Create SignInModal component with react-hook-form validation, email/password fields, show/hide toggle, forgot password link, and error handling for invalid credentials</task>
      <task id="2" acs="2.3.2, 2.3.3">Add signIn(email, password) action to authStore that calls authService.signInWithEmail and handles success/error states</task>
      <task id="3" acs="2.3.1">Update Header component to show SignInModal with "Sign In" button for anonymous users</task>
      <task id="4" acs="2.3.4">Enhance sign-out functionality to clear session, sign in anonymously, clear localStorage auth tokens, persist data in Firebase</task>
      <task id="5" acs="2.3.5">Implement Forgot Password flow with email input and Firebase password reset email</task>
      <task id="6" acs="2.3.5">Add sendPasswordResetEmail(email) method to FirebaseAuthService with error handling</task>
      <task id="7" acs="2.3.5">Add sendPasswordResetEmail to IAuthService interface</task>
      <task id="8" acs="2.3.6">Verify session management and auto-refresh via onAuthStateChanged listener and Firebase SDK</task>
      <task id="9" acs="All">End-to-end testing: sign-in journey, incorrect credentials, sign-out, forgot password, session persistence</task>
      <task id="10" acs="All">TypeScript strict mode compliance - zero errors in build</task>
      <task id="11" acs="All">Bundle size validation - verify total &lt;500KB gzipped</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="2.3.1">
      <title>Sign-in form display and validation</title>
      <given>I visit SmartBudget from a new device (not signed in)</given>
      <when>I navigate to the sign-in page or click "Sign In" link</when>
      <then>
        - I see a sign-in form with email and password fields
        - Email field validates email format (client-side)
        - Password field accepts any input (no minimum length validation on sign-in)
        - Password field has show/hide toggle
        - Submit button is disabled until both fields are filled
        - I see a "Forgot Password?" link below the form
      </then>
    </criterion>
    <criterion id="2.3.2">
      <title>Successful sign-in</title>
      <given>I have a claimed account with email "user@example.com" and password "password123"</given>
      <when>I enter correct credentials and submit</when>
      <then>
        - I am signed in and redirected to the dashboard ("/")
        - authStore.user.isAnonymous === false
        - authStore.user.email === "user@example.com"
        - I can see all my transactions and data
        - Header shows my email and "Sign Out" button
        - Authentication state persists across page refreshes
      </then>
    </criterion>
    <criterion id="2.3.3">
      <title>Incorrect credentials error handling</title>
      <given>I enter incorrect email or password</given>
      <when>I submit the sign-in form</when>
      <then>
        - Sign-in fails with error
        - I see error message: "Email or password incorrect. Please try again."
        - Form fields remain populated (except password is cleared for security)
        - I can retry with different credentials
      </then>
    </criterion>
    <criterion id="2.3.4">
      <title>Sign-out functionality</title>
      <given>I am signed in with a claimed account</given>
      <when>I click "Sign Out" button in the header</when>
      <then>
        - My session is cleared
        - I am signed in anonymously (new anonymous user)
        - authStore.user.isAnonymous === true
        - authStore.user.email === null
        - Sensitive data is cleared from localStorage (auth tokens)
        - My data in Firebase persists (not deleted)
        - Header shows "You're using SmartBudget anonymously" banner
      </then>
    </criterion>
    <criterion id="2.3.5">
      <title>Forgot password flow</title>
      <given>I click "Forgot Password?" link</given>
      <when>I enter my email address</when>
      <then>
        - Firebase sends a password reset email
        - I see confirmation: "Password reset email sent. Check your inbox."
        - The reset email contains a link to reset my password
        - Clicking the link opens Firebase's password reset page
      </then>
    </criterion>
    <criterion id="2.3.6">
      <title>Session management and auto-refresh</title>
      <given>I am signed in</given>
      <when>My auth token is about to expire</when>
      <then>
        - Firebase automatically refreshes the token
        - I remain signed in without interruption
        - onAuthStateChanged() listener syncs any auth state changes to authStore
      </then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 2: User Authentication &amp; Zero-Friction Onboarding</title>
        <section>Story 2.3: Email/Password Sign-In &amp; Sign-Out</section>
        <snippet>As a user with a claimed account, I want to sign in with my email and password from any device. Acceptance criteria cover sign-in form validation, successful sign-in flow, incorrect credentials handling, sign-out functionality, forgot password flow, and session management with auto-refresh.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision 1: Backend-as-a-Service Selection</title>
        <section>Firebase JS SDK v12.4.0</section>
        <snippet>Firebase Authentication provides native anonymous auth with linkWithCredential() for account claiming, email/password authentication, and automatic token refresh. IAuthService interface abstracts Firebase implementation: signInAnonymously(), linkWithEmail(), signInWithEmail(), signOut(), getCurrentUser(), onAuthStateChanged().</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision 3: State Management</title>
        <section>Zustand v5.0.8</section>
        <snippet>Zustand provides lightweight (~1KB) state management with persist middleware for auth state. AuthStore manages user state, isAnonymous flag, and auth actions. Example: useAuthStore with signIn() and signOut() actions, persisted to localStorage key 'auth-storage'.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/2-2-account-claiming-flow.md</path>
        <title>Story 2.2: Account Claiming Flow</title>
        <section>Dev Notes - Learnings from Previous Story</section>
        <snippet>FirebaseAuthService methods ready: signInWithEmail() at src/services/firebase/firebaseAuth.ts lines 123-146, signOut() at lines 148-158. AuthStore actions available: setUser(), clearUser(), setLoading(), setError(). Header component ready with sign-out functionality. ClaimAccountModal provides pattern for modal UI with react-hook-form validation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/auth.ts</path>
        <kind>interface</kind>
        <symbol>IAuthService</symbol>
        <lines>19-60</lines>
        <reason>Authentication service interface - signInWithEmail() and signOut() already defined. Story 2.3 will add sendPasswordResetEmail() method.</reason>
      </artifact>
      <artifact>
        <path>src/services/firebase/firebaseAuth.ts</path>
        <kind>service</kind>
        <symbol>FirebaseAuthService</symbol>
        <lines>124-146, 151-158</lines>
        <reason>Firebase auth implementation - signInWithEmail() at lines 124-146 already implemented. signOut() at lines 151-158 already implemented. Story 2.3 will add sendPasswordResetEmail() method. Uses Firebase SDK v12.4.0 modular API with error handling via AuthError.fromFirebaseError().</reason>
      </artifact>
      <artifact>
        <path>src/stores/authStore.ts</path>
        <kind>store</kind>
        <symbol>useAuthStore</symbol>
        <lines>59-124</lines>
        <reason>Zustand auth store - has setUser(), clearUser(), setLoading(), setError(), and claimAccount() actions. Story 2.3 will add signIn(email, password) action following the same pattern as claimAccount() (lines 94-112). Persisted to localStorage key 'smartbudget-auth'.</reason>
      </artifact>
      <artifact>
        <path>src/components/layout/Header.tsx</path>
        <kind>component</kind>
        <symbol>Header</symbol>
        <lines>23-39, 78-110</lines>
        <reason>Header component - has handleSignOut function (lines 23-39) and authenticated user UI (lines 78-110) with email display and Sign Out button. Story 2.3 will add "Sign In" button for anonymous users and SignInModal integration.</reason>
      </artifact>
      <artifact>
        <path>src/components/auth/ClaimAccountModal.tsx</path>
        <kind>component</kind>
        <symbol>ClaimAccountModal</symbol>
        <lines>32-100</lines>
        <reason>Modal pattern to replicate for SignInModal - uses react-hook-form validation, loading states, error handling, backdrop click-to-close, mobile-responsive design. Story 2.3 will create SignInModal following this pattern.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="firebase" version="12.4.0">Firebase JS SDK for authentication - provides signInWithEmailAndPassword, sendPasswordResetEmail</package>
        <package name="react-hook-form" version="^7.x">Form validation library - already installed, used for SignInModal validation</package>
        <package name="zustand" version="5.0.8">State management - already installed, used for authStore</package>
        <package name="react" version="^18.x">React framework</package>
        <package name="react-router-dom" version="^7.x">Client-side routing for redirects</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - Must use existing FirebaseAuthService.signInWithEmail() method (already implemented)
    - Must use existing FirebaseAuthService.signOut() method (already implemented)
    - Must follow ClaimAccountModal pattern for SignInModal (react-hook-form, Tailwind CSS, accessibility)
    - Must add signIn() action to authStore following claimAccount() pattern
    - Must add sendPasswordResetEmail() to both IAuthService interface and FirebaseAuthService class
    - Email validation must use regex pattern for client-side validation
    - Password field must have show/hide toggle for UX
    - Submit button disabled until both email and password are filled
    - Error messages must be user-friendly (not technical Firebase errors)
    - Must handle auth/user-not-found and auth/wrong-password with same error message for security
    - Sign-out must call authService.signOut() then authStore.clearUser()
    - After sign-out, AuthProvider must auto-sign in user anonymously (handled by Story 2.1 implementation)
    - Bundle size must remain &lt;500KB gzipped (SignInModal expected to add ~8KB)
    - TypeScript strict mode - no 'any' types, all async functions must return Promise types
  </constraints>
  <interfaces>
    <interface>
      <name>IAuthService.sendPasswordResetEmail</name>
      <kind>method signature</kind>
      <signature>sendPasswordResetEmail(email: string): Promise&lt;void&gt;</signature>
      <path>src/services/auth.ts</path>
    </interface>
    <interface>
      <name>authStore.signIn</name>
      <kind>Zustand action</kind>
      <signature>signIn: (email: string, password: string) =&gt; Promise&lt;void&gt;</signature>
      <path>src/stores/authStore.ts</path>
    </interface>
    <interface>
      <name>SignInModal</name>
      <kind>React component</kind>
      <signature>SignInModal({ isOpen, onClose }: { isOpen: boolean; onClose: () =&gt; void })</signature>
      <path>src/components/auth/SignInModal.tsx (NEW)</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Unit tests use Vitest 2.0 with @testing-library/react 16.1 for component testing. E2E tests use Playwright 1.50. Test files use .test.ts or .test.tsx extension and are co-located with source files. Mock Firebase SDK using Vitest mocks. Use Testing Library best practices: query by accessible roles/labels, test user behavior not implementation details. Target â‰¥80% coverage for critical business logic.
    </standards>
    <locations>
      - src/services/firebase/firebaseAuth.test.ts (unit tests for auth service)
      - src/stores/authStore.test.ts (unit tests for auth store actions)
      - src/components/auth/SignInModal.test.tsx (component tests for sign-in modal)
      - src/components/layout/Header.test.tsx (component tests for header with sign-in button)
      - e2e/auth.spec.ts (E2E tests for sign-in, sign-out, and forgot password flows)
    </locations>
    <ideas>
      <test-idea ac="2.3.1">
        SignInModal renders with email and password fields, validates email format, disables submit button until both fields filled, shows "Forgot Password?" link
      </test-idea>
      <test-idea ac="2.3.2">
        authStore.signIn() calls authService.signInWithEmail(), updates user state on success, sets isAnonymous=false
      </test-idea>
      <test-idea ac="2.3.3">
        SignInModal displays error "Email or password incorrect" on auth/wrong-password or auth/user-not-found errors, clears password field, retains email
      </test-idea>
      <test-idea ac="2.3.4">
        Header sign-out button calls authService.signOut() and authStore.clearUser(), AuthProvider auto-signs in anonymously after sign-out
      </test-idea>
      <test-idea ac="2.3.5">
        FirebaseAuthService.sendPasswordResetEmail() calls Firebase SDK sendPasswordResetEmail(), shows confirmation message on success, handles user-not-found error
      </test-idea>
      <test-idea ac="2.3.6">
        AuthProvider onAuthStateChanged listener syncs auth state changes to authStore, Firebase SDK automatically refreshes tokens
      </test-idea>
      <test-idea ac="All">
        E2E: Full sign-in journey - click "Sign In" button, enter credentials, submit, verify redirect to dashboard, verify email displayed in header, refresh page, verify session persists
      </test-idea>
      <test-idea ac="All">
        E2E: Incorrect credentials - enter wrong password, submit, verify error message, verify password cleared, retry with correct credentials, verify success
      </test-idea>
      <test-idea ac="All">
        E2E: Sign-out flow - sign in with email, click "Sign Out", verify anonymous banner appears, verify "Claim Account" and "Sign In" buttons visible
      </test-idea>
      <test-idea ac="All">
        E2E: Forgot password - click "Sign In", click "Forgot Password?", enter email, verify confirmation message displayed
      </test-idea>
    </ideas>
  </tests>
</story-context>
